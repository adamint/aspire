parameters:
  - name: buildConfig
    type: string
  - name: repoArtifactsPath
    type: string
  - name: repoLogPath
    type: string
  - name: buildArgs
    type: string
    default: ''

steps:
  - task: NodeTool@0
    displayName: ðŸŸ£Install node.js
    inputs:
      versionSpec: '20.x'

  - task: PowerShell@2
    displayName: ðŸŸ£Install yarn
    inputs:
      targetType: 'inline'
      script: |
        npm install -g yarn
        yarn --version
      workingDirectory: '$(Build.SourcesDirectory)'

  - task: PowerShell@2
    displayName: ðŸŸ£Install vsce
    inputs:
      targetType: 'inline'
      script: |
        npm install -g @vscode/vsce
        vsce --version
      workingDirectory: '$(Build.SourcesDirectory)'

  - task: PowerShell@2
    displayName: ðŸŸ£Install dependencies and run localization
    inputs:
      targetType: 'inline'
      script: |
        # Install dependencies
        yarn install

        # Compile
        yarn compile

        # Run localization
        yarn ci-localize
      workingDirectory: '$(Build.SourcesDirectory)/extension'
      errorActionPreference: 'stop'
    env:
      YARN_CACHE_FOLDER: $(Pipeline.Workspace)/.yarn

  - task: PowerShell@2
    displayName: ðŸŸ£Package extension as VSIX
    inputs:
      targetType: 'inline'
      script: |
        # Read version from package.json and package with pre-release flag
        $packageJson = Get-Content 'package.json' | ConvertFrom-Json
        $version = $packageJson.version
        Write-Host "Packaging extension version: $version"

        # Create artifacts directory if it doesn't exist - use same pattern as native build
        $artifactsDir = "${{ parameters.repoArtifactsPath }}packages"
        if (-not (Test-Path $artifactsDir)) {
          New-Item -ItemType Directory -Path $artifactsDir -Force
        }

        # Package extension using locally installed vsce
        $vsixFileName = "aspire-vscode-$version.vsix"
        vsce package --pre-release --out "$artifactsDir/$vsixFileName"

        if ($LASTEXITCODE -ne 0) {
          throw "Extension packaging failed with exit code $LASTEXITCODE"
        }

        Write-Host "Extension packaged successfully to: $artifactsDir/$vsixFileName"
      workingDirectory: '$(Build.SourcesDirectory)/extension'
      errorActionPreference: 'stop'

  - task: PowerShell@2
    displayName: ðŸŸ£List extension artifacts
    inputs:
      targetType: 'inline'
      script: |
        $artifactsDir = "${{ parameters.repoArtifactsPath }}packages"
        if (Test-Path $artifactsDir) {
          Get-ChildItem -Path $artifactsDir -Filter "*.vsix" | ForEach-Object {
            Write-Host "Found extension artifact: $($_.FullName) (Size: $([math]::Round($_.Length/1KB,2)) KB)"
          }
        } else {
          Write-Host "Artifacts directory not found: $artifactsDir"
        }

  # Sign the extension if this is not a test build
  - ${{ if ne(variables['_SignType'], 'test') }}:
    - task: PowerShell@2
      displayName: ðŸŸ£Test extension signing setup
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "=== Testing Extension Signing ==="
          Write-Host "Sign type: $env:SIGN_TYPE"
          Write-Host "Team name: $env:TEAM_NAME"
          $artifactsDir = "${{ parameters.repoArtifactsPath }}packages"
          Write-Host "Artifacts directory: $artifactsDir"

          # List files before
          Write-Host "Files in artifacts directory:"
          if (Test-Path $artifactsDir) {
            Get-ChildItem $artifactsDir -Filter "*.vsix" | ForEach-Object {
              Write-Host "  $($_.Name) - Size: $($_.Length) bytes - Modified: $($_.LastWriteTime)"
            }
          } else {
            Write-Host "  Directory not found!"
          }

          # Test if we can access the signing infrastructure
          Write-Host "=== Testing Signing Infrastructure ==="
          try {
            . $(Build.SourcesDirectory)/eng/common/tools.ps1
            Write-Host "Tools.ps1 loaded successfully"

            # Test basic MSBuild call with signing props (but don't actually sign yet)
            Write-Host "Testing basic MSBuild setup..."
            $ci = $true
            $restore = $true
            $configuration = "${{ parameters.buildConfig }}"

            Write-Host "Initializing toolset..."
            $toolsetBuildProj = InitializeToolset
            Write-Host "Toolset project: $toolsetBuildProj"

            Write-Host "Initializing build tool..."
            $buildTool = InitializeBuildTool
            Write-Host "Build tool: $($buildTool.Path) $($buildTool.Command)"

            Write-Host "=== Setup completed successfully ==="
          }
          catch {
            Write-Host "Error during setup: $_"
            Write-Host "Stack trace: $($_.ScriptStackTrace)"
          }
        errorActionPreference: 'continue'
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)
        SIGN_TYPE: $(_SignType)
        TEAM_NAME: $(_TeamName)

  - task: 1ES.PublishBuildArtifacts@1
    displayName: ðŸŸ£Publish extension artifact
    inputs:
      PathtoPublish: '${{ parameters.repoArtifactsPath }}packages/'
      ArtifactName: aspire-extension
