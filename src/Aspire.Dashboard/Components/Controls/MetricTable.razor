@using Aspire.Dashboard.Model
@using Aspire.Dashboard.Otlp.Model
@using Aspire.Dashboard.Otlp.Model.MetricValues
@using Aspire.Dashboard.Resources
@namespace Aspire.Dashboard.Components
@inject IStringLocalizer<ControlsStrings> Loc

<div style="max-height: 60vh; overflow-y: scroll; margin-bottom: 10px;" role="log">
    <FluentDataGrid Items="@FilteredMetrics.AsQueryable()" ItemSize="35" ResizableColumns="true">
        <ChildContent>
            <TemplateColumn Class="metric-grid-cell" Title="Start" Sortable="true" Tooltip="true" TooltipText="@(metric => metric.DimensionName)">
                @context.Value.Start

                @if (_anyDimensionsShown)
                {
                    <FluentIcon Icon="Icons.Filled.Size16.DataBarVertical" Color="Color.Info" Style="margin-left: 3px; vertical-align: text-bottom"/>
                }
            </TemplateColumn>
            <PropertyColumn Property="@(c => c.Value.End)" Title="End" Sortable="true"/>

            @if (InstrumentViewModel.Instrument?.Type != OtlpInstrumentType.Histogram || InstrumentViewModel.ShowCount)
            {
                <PropertyColumn Property="@(c => c.Value.Count)" Title="Count" Sortable="true"/>
                <TemplateColumn Title="Change" Sortable="true">
                    @switch (context.Direction)
                    {
                        case ValueDirectionChange.Up:
                            <FluentIcon Icon="Icons.Regular.Size24.ArrowUpRight" Color="Color.Success"/>
                            break;
                        case ValueDirectionChange.Down:
                            <FluentIcon Icon="Icons.Regular.Size24.ArrowDownLeft" Color="Color.Warning" Style="transform: scale(-1,1)"/>
                            break;
                        case ValueDirectionChange.Constant:
                            <FluentIcon Icon="Icons.Regular.Size24.ArrowLeft" Style="transform: scale(-1,1)"/>
                            break;
                    }
                </TemplateColumn>
            }
            else
            {
                var unit = PlotlyChart.GetDisplayedUnit(InstrumentViewModel, Loc);
                var percentileColumns = new List<(int Percentile, string UnderlineColor)> { (50, "#89B5D3"), (90, "#F9B980"), (99, "#8FC98F") };
                foreach (var (percentile, underlineColor) in percentileColumns)
                {
                    <TemplateColumn Title="@($"P{percentile}")" Sortable="true">
                        <span style="@($"text-decoration: underline; text-decoration-color: {underlineColor}")">@CalculatePercentile(percentile, (HistogramValue)context.Value) @unit</span>
                    </TemplateColumn>
                }
            }
        </ChildContent>
        <EmptyContent>
            There are no metric values yet.
        </EmptyContent>
    </FluentDataGrid>
</div>

<FluentStack Orientation="Orientation.Vertical">
    @if (_metrics.Count > 10)
    {
        <FluentSwitch @bind-Value="@_showLatestMetrics"
                      @bind-Value:after="ToggleFilter"
                      UncheckedMessage="Show all values"
                      CheckedMessage="Show the latest 10 values" />
    }

    <FluentSwitch @bind-Value="@_onlyShowValueChanges"
                  @bind-Value:after="ToggleOnlyShowValueChanges"
                  UncheckedMessage="Don't only show value changes"
                  CheckedMessage="Only show value changes" />
</FluentStack>

@code {
    [Parameter, EditorRequired]
    public required InstrumentViewModel InstrumentViewModel { get; set; }

    [Parameter, EditorRequired]
    public required TimeSpan Duration { get; set; }
}
